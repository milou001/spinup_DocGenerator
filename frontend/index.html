<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocGenerator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.2em; }
        .header p { opacity: 0.9; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1100px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .card h2 { color: #667eea; margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; }
        textarea, input[type=number] { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em; margin-bottom: 15px; }
        textarea { min-height: 80px; resize: vertical; }
        button { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 1em; font-weight: 600; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .result { background: #f5f5f5; padding: 12px; border-radius: 6px; border-left: 4px solid #667eea; margin-top: 10px; }
        .result .id { font-weight: 600; color: #667eea; }
        .result .score { color: #666; font-size: 0.9em; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        .loading { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä DocGenerator</h1>
        <p>Semantic Search & LLM-Based Report Generation</p>
        <p id="dbinfo" style="margin-top:8px; font-size:0.9em;"></p>
    </div>
    
    <div class="container">
        <div class="card">
            <h2>üîç Search</h2>
            <div id="searchMsg"></div>
            <label>Search Query</label>
            <textarea id="searchQuery" placeholder="z.B.: Bruch im Fahrzeugrahmen..."></textarea>
            <label>Results to Return</label>
            <input type="number" id="topN" value="5" min="1" max="20">
            <button onclick="doSearch()">Search</button>
            <div id="searchResults"></div>
        </div>
        
        <div class="card">
            <h2>‚ú® Generate Report</h2>
            <div id="genMsg"></div>
            <label>Report Brief</label>
            <textarea id="brief" placeholder="Describe what report you need..."></textarea>
            <label>Use Search Results</label>
            <input type="number" id="numResults" value="3" min="1" max="10">
            <button onclick="doGenerate()">Generate Report</button>
            <div id="genResults"></div>
        </div>
    </div>

    <script>
        // API base:
        // - If frontend is served from a different port (e.g. :8081 via python http.server),
        //   we must call the API on :8000 explicitly.
        // - If frontend is served by the API server itself, relative '/api' works.
        const API = (location.port && location.port !== '8000')
            ? (location.protocol + '//' + location.hostname + ':8000/api')
            : '/api';

        // Load status
        async function loadStatus() {
            try {
                const res = await fetch(API + '/status');
                if (res.ok) {
                    const data = await res.json();
                    const db = data.database;
                    if (db) {
                        document.getElementById('dbinfo').textContent = 
                            db.total_reports + ' Reports ¬∑ ' + db.total_chunks + ' Chunks ¬∑ ' + 
                            Math.round(data.embedding_status.percentage_complete) + '% Embedded';
                    }
                }
            } catch(e) {}
        }

        // Search
        async function doSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const topN = parseInt(document.getElementById('topN').value) || 5;
            
            if (!query) { alert('Bitte Query eingeben'); return; }
            
            document.getElementById('searchMsg').innerHTML = '<div class="loading">üîÑ Searching...</div>';
            document.getElementById('searchResults').innerHTML = '';
            
            try {
                const res = await fetch(API + '/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query, top_n: topN})
                });
                const data = await res.json();
                
                if (data.status === 'success' && data.results) {
                    document.getElementById('searchMsg').innerHTML = 
                        '<div class="success">‚úÖ ' + data.results.length + ' results found</div>';
                    
                    let html = '';
                    data.results.forEach(function(r, i) {
                        html += '<div class="result">' +
                            '<div class="id">' + (i+1) + '. ' + r.report_id + ' ‚Äî ' + (r.heading || '').substring(0,40) + '</div>' +
                            '<div class="score">üìÑ Pages ' + r.page_range + ' ¬∑ Match: ' + (r.similarity_score * 100).toFixed(1) + '%</div>' +
                            '</div>';
                    });
                    document.getElementById('searchResults').innerHTML = html;
                } else {
                    document.getElementById('searchMsg').innerHTML = 
                        '<div class="error">‚ùå ' + (data.message || 'Search failed') + '</div>';
                }
            } catch(e) {
                document.getElementById('searchMsg').innerHTML = 
                    '<div class="error">‚ùå Connection error: ' + e.message + '</div>';
            }
        }

        // Generate
        async function doGenerate() {
            const brief = document.getElementById('brief').value.trim();
            const numResults = parseInt(document.getElementById('numResults').value) || 3;
            
            if (!brief) { alert('Bitte Brief eingeben'); return; }
            
            document.getElementById('genMsg').innerHTML = '<div class="loading">üîÑ Generating report (may take 2-3 minutes on CPU)...</div>';
            document.getElementById('genResults').innerHTML = '';
            
            try {
                const res = await fetch(API + '/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({brief: brief, search_results: numResults, output_format: 'json'})
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    document.getElementById('genMsg').innerHTML = 
                        '<div class="success">‚úÖ Report generated! Sources: ' + data.num_sources + '</div>';
                    
                    let html = '<div class="result">' +
                        '<div class="id">' + data.report_title + '</div>' +
                        '<div style="margin-top:10px; font-size:0.9em; color:#444; max-height:300px; overflow-y:auto; white-space:pre-wrap;">' + 
                        (data.report_content || '').substring(0, 1000) + '...</div>' +
                        '</div>';
                    document.getElementById('genResults').innerHTML = html;
                } else {
                    document.getElementById('genMsg').innerHTML = 
                        '<div class="error">‚ùå ' + (data.message || 'Generation failed') + '</div>';
                }
            } catch(e) {
                document.getElementById('genMsg').innerHTML = 
                    '<div class="error">‚ùå Connection error: ' + e.message + '</div>';
            }
        }

        // Init
        loadStatus();
        setInterval(loadStatus, 15000);
    </script>
</body>
</html>
